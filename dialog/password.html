<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>ERP</title>
        <style>
@import "/css/fa.css";
@import "/css/dialog.css";

body,
input {
    font: 10pt "맑은 고딕", Tahoma, Arial;
}

th {
    /*background-color: #5bc0de;
    color: #fff;*/
    width: 120px;
}

td >input[type=text],
td >input[type=password] {
    width: 100%;
    padding: 0.5em;
    box-sizing: border-box;
}

        </style>
        <script>

function initialize(user) {
    const
        form = document.body.querySelector("form"),
        df = document.createDocumentFragment();

    form.elements["username"].value = user.username;

    $.request.id = user.id;
}

function showMessage(data) {
    switch (data.status) {
    case 401:
        alert("Notice!\n\n"+ "세션 만료.");

        break;
    case -1:
        console.trace(e.data.exception);
    default:
        alert("Error!\n\n"+ "오류코드: "+ data.status);
    }

    try {
        console.log(JSON.parse(data.responseText).error);
    } catch (e) {}
}

		</script>
    </head>
    <body>
        <main>
            <h2>
                비밀번호
                <span class="glyph close" id="close" title="대화창 닫기">&#xf00d;</span>
            </h2>
            <form>
                <table>
                    <tr>
                        <th>아이디</th>
                        <td>
                            <input name="username" type="text" disabled required />
                        </td>
                    </tr>
                    <tr>
                        <th>비밀번호</th>
                        <td>
                            <input name="password" type="password" required />
                        </td>
                    </tr>
                    <tr>
                        <th>비밀번호 확인</th>
                        <td>
                            <input name="password2" type="password" required />
                        </td>
                    </tr>
                </table>
                <footer>
                    <input type="submit" value="&#xf00c; 변경">
                </footer>
            </form>
        </main>

        <script src="/js/md5.js"></script>
        <script>

const $ = {
    thread: new Worker("/js/thread.js"),
    agent: window.localStorage.getItem("agent"),
    request: {
        target: "password",
        command: "set"
    }
};

if (!$.agent) {
    throw "";
}

$.thread.postMessage({
    action: "initialize",
    agent: $.agent
});

document.body.querySelector("form").onsubmit = function (e) {
    e.preventDefault();

    const
        password = this.elements["password"].value;
    
    if (password !== this.elements["password2"].value) {
        return this.elements["password"].select();
    }

    $.request.password = hex_md5(password);
    console.log(password, hex_md5(password));
    $.thread.onmessage = e => {
        switch(e.data.status) {
        case 200:
            parent.location.reload();

            break;
        case 500:
            alert("Error!\n\n비밀번호 변경 오류.");

            break;
        default:
            showMessage(e.data);
        }
    };

    $.thread.postMessage({
        action: "request",
        request: $.request
    });
};

document.getElementById("close").onclick = function (e) {
    parent.document.body.classList.remove("dialog");
};

        </script>
    </body>

</html>