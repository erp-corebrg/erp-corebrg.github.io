<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>ERP</title>
        <style>
@import "/css/style.css";
@import "/css/select.css";
@import "/css/fa.css";

body {
    width: 912px; margin: 1em auto;
    padding: 1em; box-sizing: border-box;
    border: 1px solid #777777;
    background-color: #ffffff;
    z-index: 9;
}

header {
    font-size: 2em;
    user-select: none;
    display: flex; justify-content: space-between;
}

h1 {
    text-align: center;
}

h3 {
    text-align: left;
    border-bottom: 1px solid #777777;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background-color: #34495e;
    color: #efefef;
    padding: 0.5em;
}

tbody tr:not(:last-of-type) th {
    border-bottom: 1px solid #dddddd;
}

thead th:not(:last-of-type) {
    border-right: 1px solid #dddddd;
}

td.function {
    font-family: "Font Awesome 5 Free", "맑은 고딕", Arial, Tahoma;
}

td.save::before {
    content: "\f0c7";
}

td.remove::before {
    content: "\f1f8";
}

input[type=text],
input[type=date],
input[type=number],
select,
textarea {
    padding: 0.5em;
    box-sizing: border-box;
    width: 100%; height: 100%;
}

[type=number] {
    text-align: right;
}

textarea {
    resize: none;
}

.flex {
    display: flex; align-items: center;
}

.icon,
input[type=submit] {
    font-family: 'Font Awesome 5 Free', Arial, Tahoma;
}

#company {
    flex: 1;
}

#close {
    font-family: 'Font Awesome 5 Free';
}

[name=manager] {
    flex: none;
    width: initial;
}

.button.remove,
#remove,
#buy {
    color: #dc3545;
}

.button.add,
#save,
#sale {
    color: #28a745;
}

body:not(.edit) section,
body:not(.edit) #remove {
    display: none;
}

        </style>
        <script>

function getDateString(date) {
    const
        m = date.getMonth() +1,
        d = date.getDate();

    return `${date.getFullYear()}-${m >9? m: "0"+ m}-${d >9? d: "0"+ d}`;
}

function onSaveInvoice() {
    document.body.classList.add("loading");

    const td = this.children;

    $.request.execute({
        command: "set",
        target: "invoice",
        id: Number(this.dataset.id),
        invoice: {
            expect: td[0].querySelector("input").value || undefined,
            issue: td[1].querySelector("input").value || undefined,
            complete: td[2].querySelector("input").value || undefined,
            amount: td[3].querySelector("input").value || 0,
            tax: td[4].querySelector("input").value || 0,
            comment: td[5].querySelector("input").value
        }
    }, function () {
        switch (this.status) {
        case 200:
            setSummary();

            alert(INFO_REQUEST_COMPLETE["kr"]);

            break;
        default:
            showMessage(this);
        }

        document.body.classList.remove("loading");
    });
}

function onRemoveInvoice() {
    if (!confirm(CONFIRM_REMOVE["kr"])) {
        return;
    }
    
    const tr = this;

    document.body.classList.add("loading");

    $.request.execute({
        command: "remove",
        target: "invoice",
        id: Number(this.dataset.id)
    }, function () {
        switch (this.status) {
        case 200:
            tr.parentNode.removeChild(tr);

            setSummary();

            alert(INFO_REQUEST_COMPLETE["kr"]);

            break;
        default:
            showMessage(this);
        }

        document.body.classList.remove("loading");
    });
}

function createItem(invoice) {
    const
        tr = document.createElement("tr"),
        expect = document.createElement("input"),
        complete = document.createElement("input"),
        issue = document.createElement("input"),
        amount = document.createElement("input"),
        tax = document.createElement("input"),
        comment = document.createElement("input"),
        save = document.createElement("td"),
        remove = document.createElement("td");

    tr.appendChild(document.createElement("td")).appendChild(expect).type = "date";
    tr.appendChild(document.createElement("td")).appendChild(issue).type = "date";
    tr.appendChild(document.createElement("td")).appendChild(complete).type = "date";
    tr.appendChild(document.createElement("td")).appendChild(amount).type = "number";
    tr.appendChild(document.createElement("td")).appendChild(tax).type = "number";
    tr.appendChild(document.createElement("td")).appendChild(comment).type = "text";
    tr.appendChild(save).classList.add("save", "function");
    tr.appendChild(remove).classList.add("remove", "function");

    amount.value = invoice.amount;
    amount.onchange = e => tax.value = amount.value *0.1;

    tax.value = invoice.tax || 0;
    
    comment.value = invoice.comment;

    if ("expect" in invoice) {
        expect.value = invoice.expect;
    }

    if ("issue" in invoice) {
        issue.value = invoice.issue;
    }

    if ("complete" in invoice) {
        complete.value = invoice.complete;
    }

    save.onclick = onSaveInvoice.bind(tr);
    save.title = "Save item";

    remove.onclick = onRemoveInvoice.bind(tr);
    remove.title = "Remove item";

    tr.dataset.id = invoice.id;

    return tr;
}

function onSaveOrder() {
    const project = {};

    if ([].every.call(document.body.querySelectorAll("[required]"), e => {
        if (!e.value) {
            e.focus();
        } else {
            if (e.name) {
                project[e.name] = e.type === "number"? Number(e.value): e.value;
            }

            return true;
        }
    })) {
        document.body.classList.add("loading");

        $.request.execute({
            command: $.id? "set": "add",
            target: "project",
            id: $.id,
            project: project
        }, function (e) {
            switch (this.status) {
            case 200:
                if ($.id) {
                    top.resetDialog();

                    alert(INFO_REQUEST_COMPLETE["kr"]);

                    document.body.classList.remove("loading");
                } else {
                    top.closeDialog(true);
                }

                break;
            default:
                showMessage(this);
            }
        });
    }
}

function onRemoveOrder () {
    if (!confirm(CONFIRM_REMOVE["kr"])) {
        return;
    }

    document.body.classList.add("loading");

    $.request.execute({
        command: "remove",
        target: "project",
        id: $.id,
    }, function (e) {
        switch (this.status) {
        case 200:
            top.closeDialog(true);

            break;
        case 500:
            alert(ERROR_REMOVE_RESTRICT["kr"]);
        
            document.body.classList.remove("loading");

            break;
        default:
            showMessage(this);
        }
    });
}

function setSummary() {
    var
        sale = 0,
        buy = 0;

    [].forEach.call(document.getElementById("list_sale").children, tr => {
        sale += Number(tr.querySelector("[type=number]").value);
    });

    [].forEach.call(document.getElementById("list_buy").children, tr => {
        buy += Number(tr.querySelector("[type=number]").value);
    });

    document.getElementById("sale").textContent = sale.toLocaleString();
    document.getElementById("buy").textContent = buy.toLocaleString();
    document.getElementById("profit").textContent = (sale - buy).toLocaleString();
    document.getElementById("rate").textContent = `${((sale - buy) /sale *100).toFixed(2)}%`;
}

function onAddSale() {
    addInvoice(1);
}

function onAddBuy() {
    addInvoice(2);
}

function addInvoice(type) {
    document.body.classList.add("loading");
    
    $.request.execute({
        command: "add",
        target: "invoice",
        invoice: {
            type: type,
            project: $.id
        }
    }, function () {
        switch (this.status) {
        case 200:
            window.location.reload();

            break;
        default:
            showMessage(this);
        }
    });
}

function showMessage (xhr) {
    switch (xhr.status) {
    case 401:
        alert(NOTICE_SESSION_EXPIRED["kr"]);

        break;
    default:
        alert(`${ERROR_REQUEST_CODE["kr"]}: ${xhr.status}.`);
    }

    try {
        console.log(JSON.parse(xhr.responseText).error);
    } catch (e) {}
}

		</script>
    </head>
    <body class="loading">
        <header>
            <nav>
                <span title="Save" class="button" id="save">&#xf0c7;</span>
                <span title="Remove" class="button" id="remove">&#xf1f8;</span>
                <span title="Reload" class="button" id="reload">&#xf2f1;</span>
            </nav>
            <span id="close" title="Close Document" class="button">&#xf00d;</span>
        </header>
        <h1>수주보고서</h1>
        <h3>계약 정보</h3>
        <table>
            <colgroup>
                <col width="260">
            </colgroup>
            <tbody>
                <tr>
                    <th>고객사</th>
                    <td>
                        <div id="origin"></div>
                    </td>
                </tr>
                <tr>
                    <th>프로젝트 명</th>
                    <td><input type="text" name="name" required></td>
                </tr>
                <tr>
                    <th>계약 금액 / 부가세 / 합계</th>
                    <td class="flex">
                        <input type="number" min="0" name="deposit" required>
                        <input type="number" name="tax" readonly>
                        <input type="number" name="total"" readonly>
                    </td>
                </tr>
                <tr>
                    <th>계약 일자 / 지급 조건</th>
                    <td class="flex">
                        <input type="date" name="contract" required>
                        <input type="text" name="payment" required>
                    </td>
                </tr>
                <tr>
                    <th>계약 기간</th>
                    <td class="flex">
                        <input type="date" name="start" required>
                        <span class="icon">&#xf337;</span>
                        <input type="date" name="end" required>
                    </td>
                </tr>
                <tr>
                    <th>계약 내용</th>
                    <td>
                        <textarea rows="6" name="content" required></textarea>
                    </td>
                </tr>
                <tr>
                    <th>발주처</th>
                    <td class="flex">
                        <div id="company"></div>
                        <select name="manager" required></select>
                    </td>
                </tr>
            </tbody>
        </table>
        <section>
            <h2>
                매출합계: <span id="sale"></span> 매입합계: <span id="buy"></span> 영업이익: <span id="profit"></span> / <span id="rate"></span>
            </h2>
            <h3>
                매출
                <span class="button add" title="매출 아이템 추가" id="add_sale">&#xf055;</span>
            </h3>
            <table>
                <colgroup>
                    <col width="160">
                    <col width="160">
                    <col width="160">
                    <col width="100">
                    <col width="90">
                    <col>
                    <col width="20">
                    <col width="20">
                </colgroup>
                <thead>
                    <tr>
                        <th>예정</th>
                        <th>계산서발행</th>
                        <th>입금</th>
                        <th>금액</th>
                        <th>부가세</th>
                        <th colspan="3">비고</th>
                    </tr>
                </thead>
                <tbody id="list_sale" class="item"></tbody>
            </table>
            <h3>
                매입
                <span class="button add" title="매입 아이템 추가" id="add_buy">&#xf055;</span>
            </h3>
            <table>
                <colgroup>
                    <col width="160">
                    <col width="160">
                    <col width="160">
                    <col width="100">
                    <col width="90">
                    <col>
                    <col width="20">
                    <col width="20">
                </colgroup>
                <thead>
                    <tr>
                        <th>예정</th>
                        <th>계산서발행</th>
                        <th>출금</th>
                        <th>금액</th>
                        <th>부가세</th>
                        <th colspan="3">비고</th>
                    </tr>
                </thead>
                <tbody id="list_buy" class="item"></tbody>
            </table>
        </section>

        <div class="bg_loading"></div>
        <script src="/js/request.js"></script>
        <script src="/js/select.js"></script>
        <script src="/js/constants.js"></script>
        <script>

const
    search = new URLSearchParams(window.location.search),
    $ = {
        request: new Request(),
        id: Number(search.get("id")) || undefined
    };

document.getElementById("save").onclick = onSaveOrder;
document.getElementById("remove").onclick = onRemoveOrder;
document.getElementById("reload").onclick = e => window.location.reload();
document.getElementById("close").onclick = e => top.closeDialog();
document.getElementById("add_sale").onclick = onAddSale;
document.getElementById("add_buy").onclick = onAddBuy;

document.body.querySelector("[name=deposit]").onchange = function () {
    const
        deposit = this.value,
        total = Math.round(deposit * 1.1);

    document.body.querySelector("[name=tax]").value = total - deposit;
    document.body.querySelector("[name=total]").value = total;
}

{
    const select = document.body.querySelector("[name=manager]");

    function initManager(e) {
        while(select.length > 0) {
            select.remove(0);
        }

        switch (this.status) {
        case 200:
            const
                managerData = JSON.parse(this.responseText),
                df = document.createDocumentFragment();
            let manager, option;

            for (let id in managerData) {
                manager = managerData[id];

                option = document.createElement("option");
                
                option.text = manager.name;
                option.value = id;

                df.appendChild(option);
            }

            select.appendChild(df);

            if ($.project) {
                select.value = $.project.manager;
            } else {
                select.selectedIndex = -1;
            }

            document.body.classList.remove("loading");

            break;
        default:
            showMessage(this);
        }
    }

    function resetManager () {
        document.body.classList.add("loading");

        $.request.execute({
            command: "get",
            target: "manager",
            company: $.company.value
        }, initManager);
    }
}
    
function initCompany(e) {
    switch (this.status) {
    case 200:
        const companyData = JSON.parse(this.responseText);

        $.origin = new Select({
            id: "origin",
            attr: "name",
            data: companyData
        });
        
        $.company = new Select({
            id: "company",
            attr: "name",
            data: companyData
        });

        $.company.addEventListener("change", resetManager);

        initialize();

        break;
    default:
        showMessage(this);
    }
}

function initProject () {
    switch(this.status) {
    case 200:
        const deposit = document.body.querySelector("[name=deposit]")

        $.project = JSON.parse(this.responseText);

        deposit.value = $.project.deposit;
        deposit.onchange();

        document.body.querySelector("[name=name]").value = $.project.name;
        document.body.querySelector("[name=contract]").value = $.project.contract;
        document.body.querySelector("[name=start]").value = $.project.start;
        document.body.querySelector("[name=end]").value = $.project.end;
        document.body.querySelector("[name=content]").value = $.project.content;
        document.body.querySelector("[name=payment]").value = $.project.payment;
        
        $.company.value = $.project.company;
        $.origin.value = $.project.origin;

        break;
    default:
        showMessage(this);
    }
}

function initInvoice() {
    switch(this.status) {
    case 200:
        const
            invoiceData = JSON.parse(this.responseText),
            dfS = document.createDocumentFragment(),
            dfB = document.createDocumentFragment();
        let invoice;

        for (let id in invoiceData) {
            invoice = invoiceData[id];

            if (invoice.type === 1) {
                dfS.appendChild(createItem(invoice));
            } else if (invoice.type === 2) {
                dfB.appendChild(createItem(invoice));
            }
        }

        document.getElementById("list_sale").appendChild(dfS);
        document.getElementById("list_buy").appendChild(dfB);

        setSummary();

        $.request.execute({
            command: "get",
            target: "project",
            id: $.id
        }, initProject);

        break;
    default:
        showMessage(this);
    }
}

function initialize() {
    if ($.id) {
        document.body.classList.add("edit");

        $.request.execute({
            command: "get",
            target: "invoice",
            project: $.id
        }, initInvoice);
    } else {
        document.body.classList.remove("loading");
    }   
}

$.request.execute({
    command: "get",
    target: "company"
}, initCompany);

        </script>
    </body>
</html>